# 大作业实验报告
| 学号 | 姓名 |
| :---: | :---: |
| 041903101 | 吴逸凡 |
| 181700319 | 林鑫祥 |
| 081900223 | 邱泽源 |
| 021900823 | 李忱轩 |

[GitHub 链接](https://github.com/Luoky76/P4-exercise) 

## 论文 *Implementation of multiple routing configurations on software-defined networks with p4*

  该论文通过 P4 实现了多跳路由配置。为了使通信网络保持高可靠性，论文通过 MRC 技术使得网络在发生故障时能自动恢复故障。它预先备份了多个路由配置，当配置正常的路由在转发数据时发生单节点故障或链路故障时，MRC 会立即将路由配置更改为没有使用故障路由的另一个路由配置，从而继续数据传输。通过 MRC 技术，发生故障时仅需几十毫秒就可以恢复正常通信。
  论文使用如下拓扑结构：
![拓扑结构](.\image\多跳路由\拓扑图.png)


## 论文 *Security Middleware Programming Using P4*

  该论文介绍了用 P4 语言在交换机上实现防火墙功能的方法。这个防火墙可以操作到 OSI 模型的第四层，传输层。由于 P4 交换机具有状态记忆的能力，它可以用来识别 DOS 攻击和端口扫描攻击。
  论文通过定义数个规则，使交换机拥有了对包的允许、拦截和禁止能力。无论使用 IPv4 还是 IPv6 ，TCP 还是 UDP ，它都能正确识别并运行。通过计算主机发包速率，论文还实现了对洪水攻击的检测，并在检测后能及时封锁子网或个人用户。

流程图：
![流程图](.\image\防火墙\流程图.png)

  论文将其防火墙流程划分为了7个阶段，分别是：Parsing，Check Ban List，Counters，Rules，Route forward，Ban，Drop。
  在 Parsing 阶段通过解析以太网帧的协议类型字段，将包分为 IPv4、IPv6、Other 三类。进一步可以通过解析 IP 报头的协议类型字段继续分为 UDP 包和 TCP 包。简便起见，对于 Other 类的包我们将直接丢弃。换言之，我们的交换机将只允许使用以太网协议、IPv4 协议、IPv6 协议、UDP 协议和 TCP 协议。
  在 Check Ban List 阶段，论文使用 MAC 和 IP 地址来标志一名用户，假如用户违反了规则，例如发包速率过快或是发送字节数过多，那就将其加入 Ban List 中，匹配上黑名单的包将会被立即丢弃。
  在 Counters 阶段将使用计数器统计用户的发包数和发送字节数，论文为每个表都分配了一个计数器。
  在 Rules 阶段检查 whitelist ，只允许在表中的协议或主机通过。
  在 Route forward 阶段按照协议规则转发包。
  在 Ban 阶段论文将需要禁止的用户对应的寄存器位置为1，并将其丢弃。
  在 Drop 阶段将包标记为丢弃，不会转发。

## 个人总结
### 吴逸凡
本次课程我系统地学习了 P4 语言，它在交换机上实现了前所未有的高自由度，无论是自定义报头还是自定义转发规则它都非常方便。学习期间我查找了众多资料，以下为几个我认为比较优秀的参考资料：

[P4语言介绍](https://yeya24.github.io/post/p4/) [P4语法](https://www.cnblogs.com/pullself/p/10383343.html) [利用P4实现ipv6转发实验](https://www.cnblogs.com/pullself/p/10418743.html) [P4标准元数据](https://www.jianshu.com/p/044761dc2ea9) [P4控制逻辑与完整的工作流](https://zhuanlan.zhihu.com/p/347282455) [P4知乎教程](https://www.zhihu.com/people/yaoj-x/posts) [P4的ternary匹配](https://blog.csdn.net/qq_41854763/article/details/105383669) [P4 runtime](https://blog.csdn.net/qq_33681684/article/details/123646883) [IPY的使用](https://www.cnblogs.com/cherishry/p/5916935.html) [P4 register的使用经验](https://www.codenong.com/cs106538990/) [P4编程基础](https://bbs.huaweicloud.com/blogs/detail/288890)

平台包括博客园、CSDN、知乎、华为云、简书、GitHub 等。

P4 程序目前还有不尽人意的地方，在本次学习中，我的直观感受是 P4 太难调试 Debug 了。无论是逐步调试程序还是输出中间过程调试，现有的 P4 程序都无法实现，导致出现问题时就只能看着代码自行思考代码逻辑。而且数据层和控制层的分离也意味着出错的地方不仅有可能是代码，也有可能是流表的下发规则，这也为修改错误带来许多麻烦。

由于网上 P4 教程的稀缺以及教程质量的良莠不齐，所以经常遇到问题而又无法解决，只能在一次次的试错中总结经验。这次课程也提高了我查找和阅读英文资料的能力，P4 的英文资料会比中文资料更多，也更全。

### 林鑫祥
P4 是基于 python 和 c 语言的一门新的语言，它是对计算机网络包的转发作了高度抽象，便于我们灵活地通过编写软件的方式控制硬件，或者说是可编程硬件的一种。P4里分为`parser`,`ingress`,`egress`和`deparser`几个阶段。`Ingress`和`egress`是控制流里比较重要的部分。同时了解到 ARP 转发时也去翻看了计算机网络了解到 ARP 转发以及需要用到的协议。第二次实验则是了解到隧道方式的转发通信，隧道是单向而且占用端口是不重复的。学会了通过 mycontroller.py 实现控制平面的流表下发，配置交换机。第三次实验则复习了传统的多跳路由检测和拥塞控制的知识，并用于 P4 上。通过 ecn 字段判断是否拥塞，通过递增 ipv4 的 TTL 字段，并利用 ICMP 差错报文来不断探测下一条的路由地址. 同时也了解了 tos 字段。分为6字节的区分服务 diffserv 和2字节的 ecn。复习了 TCP 协议，学习了防火墙的基本原理，学习了寄存器的基本使用，同时也了解到了 Counter 计数器。同时也查看了 V1model.p4 文件去查看了里面的内容。
平台： 去 GitHub 官网，知乎，博客园以及 CSDN 上面去找，同时也参考了老师发的资料。
通过本次实验，我对应 P4 编码能力提升，同时会通过控制平面，根据拓扑结构实现对应的流表下发。相比于传统的计算机网络，P4 可以实现很多传统网络无法实现的功能。通过可编程交换机和控制平面可以实现对传统路由无法实现的防火墙机制，并起到过滤报文的作用。也了解了学习一门新知识的不容易。

### 邱泽源
本次课程中我学习了 P4 语言的基本用法，他使得计算机网络编程变得易于上手，可以通过代码形式控制路由器转发、路由功能。通过这次学习，我认识到P4执行主要有4个阶段：`Parser`，`Ingress`，`Egress`，`Deparser`。学习过程中我学会了状态机的概念。本次学习中学会了使用 P4 语言进行隧道转发，拥塞控制和探明路由地址，建立防火墙等功能。

平台：GitHub、CSDN、老师的ppt

在本次结束后中 ，我对 P4 有了一个直观的理解，加深了我多计算机网络的理解。很感谢有一次这样的机会能够挑战一门全新的语言。

### 李忱轩
我了解到了 P4 是基于 python 的新的可编程网络语言，它对传统计算机网络做了一次高度编程化，使我们可以通过代码形式控制路由器转发、路由功能，通过这次学习，我认识到：P4 里分为四大阶段。`Ingress`阶段与`egress`阶段是其中的核心部分。同时对传统计算机网络中的 ARP 协议有了更深的了解。在之后，通过实现隧道的转发通信，了解到了隧道的基本特性， 之后学习通过 ecn 字段判断是否拥塞，学习了利用`traceroute`来探测下一跳的路由地址. 了解了 tos 字段。在大作业中，学习了防火墙的基本原理。
平台：GitHub、博客园、CSDN 、stackoverflow、老师 ppt 和相关教程。
在本次结束后中 ，我对 P4 有了一个直观的理解，并初步学会了相关编码对过程，比如通过控制平面，利用相关的拓扑结构实现对应流表下发。在这次学习过程中，我了解了P4的相关特性，比如可以通过可编程交换机和控制平面实现防火墙、过滤报文等功能。

